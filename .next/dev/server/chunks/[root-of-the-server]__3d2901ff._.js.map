{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/User/Desktop/agent-portal-dashboard/app/api/workspaces/route.ts"],"sourcesContent":["import { Pool } from \"pg\";\r\nimport { NextRequest, NextResponse } from \"next/server\";\r\n\r\n// Database connection\r\nconst pool = new Pool({\r\n  user: process.env.PG_USER || \"postgres\",\r\n  host: process.env.PG_HOST || \"localhost\",\r\n  database: process.env.PG_DATABASE || \"agent-portal\",\r\n  password: process.env.PG_PASSWORD || \"postgres12345\",\r\n  port: Number(process.env.PG_PORT) || 5432,\r\n});\r\n\r\n// // GET all workspaces\r\n// export async function GET(request: NextRequest) {\r\n//   try {\r\n//     const result = await pool.query(\r\n//       \"SELECT id, agent_name as agent, status, agent_status as \\\"agentStatus\\\" FROM workspaces ORDER BY created_at DESC\"\r\n//     );\r\n//     console.log(\"Fetched workspaces:\", result.rows);\r\n//     return NextResponse.json({ workspaces: result.rows });\r\n//   } catch (error) {\r\n//     console.error(\"Error fetching workspaces:\", error);\r\n//     return NextResponse.json(\r\n//       { error: \"Failed to fetch workspaces\" },\r\n//       { status: 500 }\r\n//     );\r\n//   }\r\n// }\r\n\r\n// POST to update a workspace\r\nexport async function POST(request: NextRequest) {\r\n  try {\r\n    const { workspaceId, action } = await request.json();\r\n\r\n    if (!workspaceId || !action) {\r\n      return NextResponse.json(\r\n        { error: \"Missing workspaceId or action\" },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    // Map actions to status\r\n    const statusMap: { [key: string]: string } = {\r\n      login: \"active\",\r\n      logout: \"suspended\",\r\n    };\r\n\r\n    // Map actions to agent_status\r\n    const agentStatusMap: { [key: string]: string } = {\r\n      ready: \"READY\",\r\n      pause: \"PAUSE\",\r\n      \"in-call\": \"IN-CALL\",\r\n    };\r\n\r\n    // Determine if this is a status or agent_status action\r\n    if (statusMap[action]) {\r\n      const newStatus = statusMap[action];\r\n      \r\n      // When login, set agent_status to READY; when logout, set agent_status to PAUSE\r\n      const autoAgentStatus = action === \"login\" ? \"READY\" : \"PAUSE\";\r\n      \r\n      console.log(`Updating workspace ${workspaceId} status to ${newStatus} and agent_status to ${autoAgentStatus}`);\r\n      const result = await pool.query(\r\n        \"UPDATE workspaces SET status = $1, agent_status = $2 WHERE id = $3 RETURNING *\",\r\n        [newStatus, autoAgentStatus, workspaceId]\r\n      );\r\n\r\n      if (result.rowCount === 0) {\r\n        return NextResponse.json(\r\n          { error: \"Workspace not found\" },\r\n          { status: 404 }\r\n        );\r\n      }\r\n\r\n      return NextResponse.json({\r\n        message: \"Workspace updated successfully\",\r\n        workspace: result.rows[0],\r\n      });\r\n    } else if (agentStatusMap[action]) {\r\n      // Check if user is logged in before allowing agent_status change\r\n      const workspace = await pool.query(\r\n        \"SELECT status FROM workspaces WHERE id = $1\",\r\n        [workspaceId]\r\n      );\r\n\r\n      if (workspace.rowCount === 0) {\r\n        return NextResponse.json(\r\n          { error: \"Workspace not found\" },\r\n          { status: 404 }\r\n        );\r\n      }\r\n\r\n      const currentStatus = workspace.rows[0].status;\r\n      \r\n      // Only allow agent_status change if status is \"active\" (logged in)\r\n      if (currentStatus !== \"active\") {\r\n        return NextResponse.json(\r\n          { error: \"Cannot change agent status when user is not logged in\" },\r\n          { status: 400 }\r\n        );\r\n      }\r\n\r\n      const newAgentStatus = agentStatusMap[action];\r\n      console.log(`Updating workspace ${workspaceId} agent_status to ${newAgentStatus}`);\r\n      const result = await pool.query(\r\n        \"UPDATE workspaces SET agent_status = $1 WHERE id = $2 RETURNING *\",\r\n        [newAgentStatus, workspaceId]\r\n      );\r\n\r\n      if (result.rowCount === 0) {\r\n        return NextResponse.json(\r\n          { error: \"Workspace not found\" },\r\n          { status: 404 }\r\n        );\r\n      }\r\n\r\n      console.log(\"Updated workspace:\", result.rows[0]);\r\n      return NextResponse.json({\r\n        message: \"Agent status updated successfully\",\r\n        workspace: result.rows[0],\r\n      });\r\n    } else {\r\n      return NextResponse.json(\r\n        { error: \"Invalid action\" },\r\n        { status: 400 }\r\n      );\r\n    }\r\n  } catch (error) {\r\n    console.error(\"Error updating workspace:\", error);\r\n    return NextResponse.json(\r\n      { error: \"Failed to update workspace\" },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}}]
}